# 前后端接口设计适配性分析计划

## 一、分析目标

基于 REST API 设计规范，评估当前前端实现与后端接口的适配性，识别问题并提出改进建议。

## 二、后端 API 设计现状分析

### 2.1 API 路由结构

当前后端 API 采用 `/api/v1` 前缀，包含以下模块：

| 模块            | 路径                      | 功能   |
| ------------- | ----------------------- | ---- |
| auth          | `/api/v1/auth`          | 用户认证 |
| conversations | `/api/v1/conversations` | 会话管理 |
| chat          | `/api/v1/chat`          | 聊天功能 |
| models        | `/api/v1/models`        | 模型列表 |
| skills        | `/api/v1/skills`        | 技能调用 |
| files         | `/api/v1/files`         | 文件管理 |
| knowledge     | `/api/v1/knowledge`     | 知识库  |

### 2.2 响应格式问题

#### 问题1：响应格式不一致

**现状：**

* conversations 接口直接返回数据：`[{id, title, ...}]`

* skills 接口返回包装格式：`{success: true, data: {...}}`

* chat/send 非流式返回：`{response: "..."}`

* 异常返回：`{error: {code, message, details}}`

**规范要求：**

```JSON
// 成功响应 - 单个资源
{
  "data": { "id": 1, "name": "..." }
}

// 错误响应
{
  "error": {
    "code": "validation_error",
    "message": "...",
    "details": [...]
  }
}
```

#### 问题2：错误处理不统一

**现状：**

* `DragonAIException` 返回标准格式：`{error: {code, message, details}}`

* `HTTPException` 返回 FastAPI 默认格式：`{detail: "..."}`

**影响：** 前端无法统一处理错误响应

### 2.3 URL 设计问题

#### 问题3：接口路径不匹配前端调用

**现有后端接口：**

```
POST /api/v1/skills/direct/image/generate
POST /api/v1/skills/direct/image/edit
POST /api/v1/skills/direct/code/assist
POST /api/v1/skills/direct/translate
```

**前端实际调用：**

```
POST /api/v1/skills/translation  (Translation.vue)
POST /api/v1/skills/coding       (Coding.vue)
POST /api/v1/skills/direct/image/generate  (chat.ts)
POST /api/v1/skills/direct/image/edit      (skill.ts)
```

**改进方案：** 修改后端接口路径以匹配前端调用

```
POST /api/v1/skills/translation
POST /api/v1/skills/coding
POST /api/v1/skills/image-generation
POST /api/v1/skills/image-editing
```

### 2.4 参数不匹配问题

#### 问题4：翻译接口参数不匹配

**前端发送 (Translation.vue)：**

```typescript
{
  text: string,
  target_lang: string,
  is_expert: boolean,    // ❌ 后端期望 model_mode
  source_lang?: string
}
```

**后端期望 (skills.py)：**

```python
class TranslateRequest(BaseModel):
    text: str
    target_lang: str
    source_lang: Optional[str] = None
    model_mode: Literal["fast", "expert"]  // ❌ 前端发送 is_expert
```

#### 问题5：编程接口参数不匹配

**前端发送 (Coding.vue)：**

```typescript
{
  prompt: string,
  is_expert: boolean,      // ❌ 后端期望 model_mode
  temperature?: number,    // ❌ 后端不支持
  max_tokens?: number      // ❌ 后端不支持
}
```

**后端期望 (skills.py)：**

```python
class CodeAssistRequest(BaseModel):
    prompt: str
    language: str = "python"
    model_mode: Literal["fast", "expert"] = "fast"
    stream: bool = True
```

### 2.5 响应结构不匹配

#### 问题6：翻译响应结构不匹配

**前端期望 (Translation.vue)：**

```typescript
result.value = response.text           // 期望直接访问 text
modelName.value = response.model_name  // 期望 model_name
```

**后端当前返回：**

```json
{
  "success": true,
  "data": {
    "original": "...",
    "translated": "...",
    "source_lang": "auto",
    "target_lang": "en"
  }
}
```

#### 问题7：编程响应结构不匹配

**前端期望 (Coding.vue)：**

```typescript
result.value = response  // 期望包含 content, model_name, thinking_content
```

**后端当前返回：**

```json
{
  "success": true,
  "data": {
    "content": "..."
  }
}
```

## 三、后端修改计划

### 3.1 skills.py 接口修改

#### 修改1：翻译接口

**修改路径：**

```python
# 旧路径
@router.post("/direct/translate")

# 新路径
@router.post("/translation")
```

**修改请求模型：**

```python
class TranslationRequest(BaseModel):
    text: str = Field(..., description="待翻译文本")
    target_lang: str = Field(..., description="目标语言")
    is_expert: bool = Field(False, description="是否使用专家模型")
    source_lang: Optional[str] = Field(None, description="源语言")
```

**修改响应模型：**

```python
class TranslationResponse(BaseModel):
    text: str = Field(..., description="翻译结果")
    model_name: str = Field(..., description="使用的模型名称")
```

**修改接口实现：**

```python
@router.post("/translation", response_model=TranslationResponse)
async def translate(
    request: TranslationRequest,
    current_user: User = Depends(get_current_active_user)
):
    model = ModelFactory.get_translation_model(is_plus=request.is_expert)
    result = await model.atranslate(
        text=request.text,
        source_lang=request.source_lang,
        target_lang=request.target_lang
    )
    return TranslationResponse(
        text=result,
        model_name="expert" if request.is_expert else "fast"
    )
```

#### 修改2：编程接口

**修改路径：**

```python
# 旧路径
@router.post("/direct/code/assist")

# 新路径
@router.post("/coding")
```

**修改请求模型：**

```python
class CodingRequest(BaseModel):
    prompt: str = Field(..., description="编程需求")
    is_expert: bool = Field(False, description="是否使用专家模型")
    temperature: Optional[float] = Field(None, ge=0, le=2, description="温度参数")
    max_tokens: Optional[int] = Field(None, ge=1, description="最大token数")
```

**修改响应模型：**

```python
class CodingResponse(BaseModel):
    content: str = Field(..., description="生成的内容")
    model_name: str = Field(..., description="使用的模型名称")
    thinking_content: Optional[str] = Field(None, description="思考过程")
    reasoning_content: Optional[str] = Field(None, description="推理过程")
```

**修改接口实现：**

```python
@router.post("/coding", response_model=CodingResponse)
async def coding(
    request: CodingRequest,
    current_user: User = Depends(get_current_active_user)
):
    model = ModelFactory.get_coder_model(is_plus=request.is_expert)
    
    messages = [
        {"role": "system", "content": "你是一个专业的编程助手。请提供清晰、高效、有注释的代码，并解释关键逻辑。"},
        {"role": "user", "content": request.prompt}
    ]
    
    result = await model.ainvoke(messages)
    
    return CodingResponse(
        content=result.content,
        model_name="expert" if request.is_expert else "fast",
        thinking_content=getattr(result, 'thinking_content', None),
        reasoning_content=getattr(result, 'reasoning_content', None)
    )
```

#### 修改3：图像生成接口

**修改路径：**

```python
# 旧路径
@router.post("/direct/image/generate")

# 新路径
@router.post("/image-generation")
```

#### 修改4：图像编辑接口

**修改路径：**

```python
# 旧路径
@router.post("/direct/image/edit")

# 新路径
@router.post("/image-editing")
```

### 3.2 schemas/skills.py 修改

更新请求和响应模型定义，确保与前端期望一致。

## 四、前端修改计划

### 4.1 skill.ts 统一请求工具

**修改内容：**

```typescript
// 旧代码
import axios from 'axios'
const response = await axios.post('/api/v1/skills/direct/image/generate', params)

// 新代码
import request from '@/utils/request'
const response = await request.post('/api/v1/skills/image-generation', params)
```

### 4.2 chat.ts 图像接口路径更新

**修改内容：**

```typescript
// 旧路径
const response = await request.post('/api/v1/skills/direct/image/generate', {...})

// 新路径
const response = await request.post('/api/v1/skills/image-generation', {...})
```

## 五、执行步骤

### 阶段一：后端接口修改

1. 修改 `app/schemas/skills.py`

   * 更新 TranslationRequest/Response

   * 更新 CodingRequest/Response

2. 修改 `app/api/v1/skills.py`

   * 修改翻译接口路径和实现

   * 修改编程接口路径和实现

   * 修改图像接口路径

### 阶段二：前端适配

1. 修改 `frontend/src/stores/skill.ts`

   * 使用封装的 request

   * 更新接口路径

2. 修改 `frontend/src/stores/chat.ts`

   * 更新图像接口路径

## 六、问题汇总

| 编号 | 问题                               | 解决方案                                          | 优先级 |
| -- | -------------------------------- | --------------------------------------------- | --- |
| 1  | 翻译接口路径不匹配                        | 修改为 `/skills/translation`                     | 高   |
| 2  | 编程接口路径不匹配                        | 修改为 `/skills/coding`                          | 高   |
| 3  | 翻译参数 `is_expert` vs `model_mode` | 后端接收 `is_expert`                              | 高   |
| 4  | 编程参数不匹配                          | 后端接收 `is_expert`, `temperature`, `max_tokens` | 高   |
| 5  | 翻译响应结构不匹配                        | 返回 `{text, model_name}`                       | 高   |
| 6  | 编程响应结构不匹配                        | 返回 `{content, model_name, thinking_content?}` | 高   |
| 7  | 图像接口路径                           | 修改为 `/skills/image-generation`                | 中   |
| 8  | skill.ts 使用原生 axios              | 改用封装的 request                                 | 中   |

## 七、验收标准

* [ ] Translation.vue 翻译功能正常

* [ ] Coding.vue 代码生成功能正常

* [ ] 图像生成/编辑功能正常

* [ ] 无 TypeScript 类型错误

