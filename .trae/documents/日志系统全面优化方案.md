## 日志系统优化方案

### 问题诊断

经过分析，发现以下主要问题：

1. **日志量过大**
   - SQLAlchemy 每条 SQL 都输出日志（echo=True）
   - 缓存操作每次都记录 INFO 级别日志
   - SSE 流式传输每个 chunk 都记录日志
   - 缓存预热产生大量重复日志

2. **日志级别使用不当**
   - 大量常规操作使用 INFO 级别
   - 缺少 DEBUG 级别的详细调试信息
   - 重要信息被淹没在大量低价值日志中

3. **日志内容冗余**
   - `[REDIS] Serialized value` 包含完整数据内容
   - SQL 日志包含完整语句和参数
   - 结构化日志和普通日志重复输出

4. **第三方库日志未控制**
   - SQLAlchemy Engine 日志未过滤
   - 其他库日志可能干扰

---

### 优化计划

#### 1. 创建统一日志配置模块 `app/core/logging_config.py`
- 集中管理日志级别、格式、处理器
- 提供环境感知的配置（开发/测试/生产）
- 实现第三方库日志过滤器

#### 2. 建立日志分级标准
| 级别 | 使用场景 |
|------|----------|
| DEBUG | SQL查询、缓存操作详情、SSE chunk详情 |
| INFO | 请求开始/结束、Agent创建、消息保存、重要业务事件 |
| WARNING | 缓存预热失败、限流触发、降级操作 |
| ERROR | 异常情况、API调用失败 |
| FATAL | 系统启动失败、严重错误 |

#### 3. 优化各模块日志

**redis.py**:
- `[CACHE HIT/MISS/SET]` 降级为 DEBUG
- 移除 `[REDIS] Serialized value` 冗余日志
- 简化缓存失效日志

**cache_warmup.py**:
- 预热过程日志降级为 DEBUG
- 只在完成/失败时记录 INFO/WARNING

**chat_service.py**:
- SSE chunk 日志降级为 DEBUG
- 移除冗余的调试日志
- 保留关键业务日志

**database.py**:
- 生产环境设置 `echo=False`
- 保留初始化日志

**debug_middleware.py**:
- System prompt 日志降级为 DEBUG

**chat.py (API)**:
- SSE 详细日志降级为 DEBUG
- 保留请求级别的 INFO 日志

#### 4. 实现日志轮转优化
- 使用 `TimedRotatingFileHandler` 按天切割
- 保留大小限制作为备用
- 配置日志保留天数

#### 5. 添加第三方库日志控制
- SQLAlchemy Engine: WARNING 级别
- httpx: WARNING 级别
- 其他库按需配置

---

### 预期效果

- 日志量减少 70-80%
- 重要信息突出，便于排查问题
- 存储占用合理
- 支持按需开启详细调试日志